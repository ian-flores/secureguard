<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Guardrail Patterns • secureguard</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Guardrail Patterns">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">secureguard</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/secureguard.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/secureguard/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced Guardrail Patterns</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/secureguard/blob/main/vignettes/advanced-patterns.Rmd" class="external-link"><code>vignettes/advanced-patterns.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-patterns.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="what-this-vignette-covers">What This Vignette Covers<a class="anchor" aria-label="anchor" href="#what-this-vignette-covers"></a>
</h2>
<p>The getting-started vignette (<code><a href="../articles/secureguard.html">vignette("secureguard")</a></code>)
introduces the three defense layers and the built-in guardrails. This
vignette goes deeper. It covers building your own guardrails for
domain-specific threats, composing guardrails into layered defenses with
fine-grained control over pass/fail logic, assembling full pipelines
that protect every stage of an agent turn, and integrating with securer
for sandboxed execution.</p>
<p>If you are new to secureguard, start with
<code><a href="../articles/secureguard.html">vignette("secureguard")</a></code> first.</p>
</div>
<div class="section level2">
<h2 id="how-a-guardrail-pipeline-works">How a Guardrail Pipeline Works<a class="anchor" aria-label="anchor" href="#how-a-guardrail-pipeline-works"></a>
</h2>
<p>Before diving into custom guardrails, it helps to see how the pieces
fit together in a complete agent workflow. The following diagram shows
the flow of data through a <code><a href="../reference/secure_pipeline.html">secure_pipeline()</a></code> – the
recommended way to wire guardrails into an agent loop:</p>
<pre><code>         User prompt
              |
              v
    +--------------------+
    |  check_input()     |    Input guardrails:
    |  - injection       |    prompt injection, topic scope, PII
    |  - topic scope     |
    |  - input PII       |
    +--------------------+
              |
         Pass? ----No----&gt; Return failure (stage: input)
              |
             Yes
              |
              v
         LLM generates code
              |
              v
    +--------------------+
    |  check_code()      |    Code guardrails:
    |  - AST analysis    |    blocked functions, complexity,
    |  - complexity      |    dependencies, data flow
    |  - dependencies    |
    |  - data flow       |
    +--------------------+
              |
         Pass? ----No----&gt; Return failure (stage: code)
              |
             Yes
              |
              v
      Execute in sandbox
        (securer)
              |
              v
    +--------------------+
    |  check_output()    |    Output guardrails:
    |  - PII             |    PII blocking, secret redaction,
    |  - secrets         |    size limits
    |  - size            |
    +--------------------+
              |
         Pass? ----No----&gt; Return failure (stage: output)
              |
             Yes
              |
              v
      Return result to user
      (possibly redacted)</code></pre>
<p>Each stage short-circuits on failure: if input guardrails reject the
prompt, the LLM never sees it. If code guardrails reject the generated
code, it never executes. This minimizes both risk and wasted
computation.</p>
</div>
<div class="section level2">
<h2 id="creating-custom-guardrails">Creating Custom Guardrails<a class="anchor" aria-label="anchor" href="#creating-custom-guardrails"></a>
</h2>
<p>The built-in guardrails cover the most common threats: prompt
injection, dangerous function calls, PII leakage, and secret exposure.
But every application has domain-specific risks that generic guardrails
cannot anticipate. An agent that generates SQL needs SQL injection
detection. A healthcare application needs HIPAA-specific PII patterns. A
financial tool needs checks for account numbers and routing numbers.</p>
<p>secureguard is designed for extensibility. Every guardrail – built-in
or custom – is an S3 object of class <code>secureguard</code> with four
properties: <code>name</code>, <code>type</code>, <code>check_fn</code>,
and <code>description</code>. The <code><a href="../reference/new_guardrail.html">new_guardrail()</a></code>
constructor validates these and returns a guardrail you can use with
<code><a href="../reference/run_guardrail.html">run_guardrail()</a></code>, <code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code>, and
<code><a href="../reference/secure_pipeline.html">secure_pipeline()</a></code>. Custom guardrails compose seamlessly
with built-in ones because they share the same interface.</p>
<div class="section level3">
<h3 id="a-sql-injection-detector">A SQL Injection Detector<a class="anchor" aria-label="anchor" href="#a-sql-injection-detector"></a>
</h3>
<p>SQL injection is one of the oldest and most well-understood attack
vectors in software. When an LLM generates SQL queries, the risk is
amplified: the model may produce syntactically valid but semantically
dangerous queries, especially if the user’s prompt contains adversarial
patterns. A purpose-built guardrail can catch these patterns before any
query reaches a database.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/secureguard/">secureguard</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">guard_sql_injection</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sql_patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"(?i)\\b(?:UNION\\s+SELECT|DROP\\s+TABLE|DELETE\\s+FROM)\\b"</span>,</span>
<span>    <span class="st">"(?i)\\b(?:INSERT\\s+INTO|UPDATE\\s+.+\\s+SET)\\b.*?;\\s*--"</span>,</span>
<span>    <span class="st">"(?i)'\\s*(?:OR|AND)\\s+['\"]?\\d['\"]?\\s*=\\s*['\"]?\\d"</span>,</span>
<span>    <span class="st">"(?i)(?:--|#|/\\*).*(?:SELECT|DROP|INSERT|UPDATE|DELETE)"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">check_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">hits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">sql_patterns</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pat</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">pat</span>, <span class="va">x</span>, perl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">hits</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/guardrail_result.html">guardrail_result</a></span><span class="op">(</span></span>
<span>        pass <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        reason <span class="op">=</span> <span class="st">"Potential SQL injection detected"</span>,</span>
<span>        details <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          matched_patterns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">hits</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/guardrail_result.html">guardrail_result</a></span><span class="op">(</span>pass <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_guardrail.html">new_guardrail</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"sql_injection"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"input"</span>,</span>
<span>    check_fn <span class="op">=</span> <span class="va">check_fn</span>,</span>
<span>    description <span class="op">=</span> <span class="st">"Detects common SQL injection patterns"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now use it like any built-in guardrail:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">guard_sql_injection</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g</span></span>
<span><span class="co">#&gt; &lt;secureguard&gt; <span style="font-weight: bold;">sql_injection</span> (input)</span></span>
<span><span class="co">#&gt; Detects common SQL injection patterns</span></span>
<span></span>
<span><span class="co"># Safe query</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">"SELECT name FROM users WHERE id = 42"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span></span>
<span><span class="co"># Injection attempt</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">"SELECT * FROM users WHERE id = 1; DROP TABLE users; --"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Potential SQL injection detected</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a-code-length-limiter">A Code Length Limiter<a class="anchor" aria-label="anchor" href="#a-code-length-limiter"></a>
</h3>
<p>Custom guardrails of type <code>"code"</code> work exactly the same
way. Here is one that limits the number of lines in LLM-generated
code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">guard_code_length</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">max_lines</span> <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">check_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">code</span>, <span class="st">"\n"</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">n_lines</span> <span class="op">&gt;</span> <span class="va">max_lines</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/guardrail_result.html">guardrail_result</a></span><span class="op">(</span></span>
<span>        pass <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        reason <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Code has %d lines (max %d)"</span>, <span class="va">n_lines</span>, <span class="va">max_lines</span><span class="op">)</span>,</span>
<span>        details <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n_lines <span class="op">=</span> <span class="va">n_lines</span>, max_lines <span class="op">=</span> <span class="va">max_lines</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/guardrail_result.html">guardrail_result</a></span><span class="op">(</span>pass <span class="op">=</span> <span class="cn">TRUE</span>, details <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n_lines <span class="op">=</span> <span class="va">n_lines</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_guardrail.html">new_guardrail</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"code_length"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"code"</span>,</span>
<span>    check_fn <span class="op">=</span> <span class="va">check_fn</span>,</span>
<span>    description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Limits code to %d lines"</span>, <span class="va">max_lines</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">g_len</span> <span class="op">&lt;-</span> <span class="fu">guard_code_length</span><span class="op">(</span>max_lines <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">g_len</span>, <span class="st">"x &lt;- 1\ny &lt;- 2\nz &lt;- x + y"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span></span>
<span><span class="va">long_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"x%d &lt;- %d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">g_len</span>, <span class="va">long_code</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Code has 10 lines (max 5)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="anatomy-of-a-check_fn">Anatomy of a check_fn<a class="anchor" aria-label="anchor" href="#anatomy-of-a-check_fn"></a>
</h3>
<p>Every <code>check_fn</code> must:</p>
<ol style="list-style-type: decimal">
<li>Accept a single argument (the text or object to check).</li>
<li>Return a <code><a href="../reference/guardrail_result.html">guardrail_result()</a></code> with at minimum
<code>pass = TRUE</code> or <code>pass = FALSE</code>.</li>
<li>Optionally include <code>reason</code> (why it failed),
<code>warnings</code> (advisory notes), and <code>details</code> (a
named list of metadata).</li>
</ol>
<p>The <code>@</code> operator accesses properties on the result:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"system('ls')"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">reason</span></span>
<span><span class="co">#&gt; [1] "Blocked function(s) detected: system"</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">details</span></span>
<span><span class="co">#&gt; $blocked_calls</span></span>
<span><span class="co">#&gt; [1] "system"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="composing-guardrails">Composing Guardrails<a class="anchor" aria-label="anchor" href="#composing-guardrails"></a>
</h2>
<p>Individual guardrails are building blocks. In practice, you almost
always want to run multiple guardrails together – checking both for
dangerous functions and excessive complexity, or detecting both prompt
injection and off-topic prompts. secureguard provides two composition
mechanisms that make this natural.</p>
<div class="section level3">
<h3 id="compose_guardrails-same-type-composition">compose_guardrails(): Same-Type Composition<a class="anchor" aria-label="anchor" href="#compose_guardrails-same-type-composition"></a>
</h3>
<p><code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code> merges multiple guardrails of the
<strong>same type</strong> into a single composite guardrail. The result
is itself a guardrail, which means you can pass it to
<code><a href="../reference/run_guardrail.html">run_guardrail()</a></code>, nest it inside another composition, or use
it in a pipeline. This is useful when you want to treat a group of
checks as one unit – for example, bundling all your code checks into a
single “strict code” guardrail.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compose three code guardrails -- ALL must pass (default)</span></span>
<span><span class="va">strict_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">10</span>, max_calls <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dependencies.html">guard_code_dependencies</a></span><span class="op">(</span>allowed_packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">strict_code</span></span>
<span><span class="co">#&gt; &lt;secureguard&gt; <span style="font-weight: bold;">composed(code_analysis + code_complexity + code_dependencies)</span></span></span>
<span><span class="co">#&gt; (code)</span></span>
<span><span class="co">#&gt; Composite guardrail (mode=all): code_analysis + code_complexity +</span></span>
<span><span class="co">#&gt; code_dependencies</span></span>
<span></span>
<span><span class="co"># Clean code passes all three</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">strict_code</span>, <span class="st">"dplyr::filter(mtcars, cyl == 4)"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span></span>
<span><span class="co"># system() fails code analysis</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">strict_code</span>, <span class="st">"system('whoami')"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Blocked function(s) detected: system</span></span>
<span></span>
<span><span class="co"># processx fails dependency check</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">strict_code</span>, <span class="st">"processx::run('ls')"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Blocked function(s) detected: processx::run; Disallowed package(s):</span></span>
<span><span class="co">#&gt; processx</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mode-any-at-least-one-must-pass">mode = “any”: At Least One Must Pass<a class="anchor" aria-label="anchor" href="#mode-any-at-least-one-must-pass"></a>
</h3>
<p>The default <code>mode = "all"</code> is the right choice for
security checks: all guards must pass. But sometimes you need the
opposite logic – an allowlist where the input is acceptable if it
matches <strong>any</strong> of several categories. With
<code>mode = "any"</code>, the composite passes if at least one child
guardrail passes:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Accept prompts about either statistics OR machine learning</span></span>
<span><span class="va">topic_guard</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_topic_scope.html">guard_topic_scope</a></span><span class="op">(</span>allowed_topics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"statistics"</span>, <span class="st">"regression"</span>, <span class="st">"t-test"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_topic_scope.html">guard_topic_scope</a></span><span class="op">(</span>allowed_topics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"machine learning"</span>, <span class="st">"neural network"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"any"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">topic_guard</span>, <span class="st">"How do I run a t-test in R?"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">topic_guard</span>, <span class="st">"Explain neural network backpropagation"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">topic_guard</span>, <span class="st">"What is the weather today?"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Input does not match any allowed topic.; Input does not match any</span></span>
<span><span class="co">#&gt; allowed topic.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="check_all-run-a-list-and-collect-results">check_all(): Run a List and Collect Results<a class="anchor" aria-label="anchor" href="#check_all-run-a-list-and-collect-results"></a>
</h3>
<p>Sometimes you need individual results from each guardrail rather than
a single composite result. <code><a href="../reference/check_all.html">check_all()</a></code> runs a list of
guardrails and returns a summary:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">guards</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_all.html">check_all</a></span><span class="op">(</span><span class="va">guards</span>, <span class="st">"x &lt;- mean(1:10)"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">results</span><span class="op">)</span>  <span class="co"># one per guardrail</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span></span>
<span><span class="co"># Inspect individual results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">@</span><span class="va">pass</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE</span></span></code></pre></div>
<p>When a check fails, <code><a href="../reference/check_all.html">check_all()</a></code> collects all failure
reasons:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_all.html">check_all</a></span><span class="op">(</span><span class="va">guards</span>, <span class="st">"Sys.getenv('SECRET_KEY')"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">reasons</span></span>
<span><span class="co">#&gt; [1] "Data flow violation(s): Sys.getenv"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="when-to-use-compose_guardrails-vs-check_all">When to Use compose_guardrails() vs check_all()<a class="anchor" aria-label="anchor" href="#when-to-use-compose_guardrails-vs-check_all"></a>
</h3>
<p>Both functions combine multiple guardrails, but they serve different
purposes and return different types:</p>
<p><strong>Use <code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code></strong> when you want
a single guardrail object that you can pass to
<code><a href="../reference/run_guardrail.html">run_guardrail()</a></code>, nest inside another
<code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code>, or use in a
<code><a href="../reference/secure_pipeline.html">secure_pipeline()</a></code>. The composed guardrail behaves as one
unit: you get a single pass/fail result. This is the right choice when
you are building reusable guardrail configurations (e.g., a “strict
code” composite) that you want to treat as a single check.</p>
<p><strong>Use <code><a href="../reference/check_all.html">check_all()</a></code></strong> when you need
diagnostic detail. It returns individual results for each guardrail in
the list, so you can report exactly which checks failed and why. This is
useful in logging, debugging, and user-facing error messages where “code
guardrail failed” is less helpful than “blocked function
<code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code> detected by code_analysis; exceeded max AST depth
of 10 per code_complexity.”</p>
<p>In practice, many applications use both:
<code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code> to build reusable guardrail groups,
and <code><a href="../reference/check_all.html">check_all()</a></code> at the top level to get per-group
diagnostics.</p>
</div>
</div>
<div class="section level2">
<h2 id="building-pipelines-with-secure_pipeline">Building Pipelines with secure_pipeline()<a class="anchor" aria-label="anchor" href="#building-pipelines-with-secure_pipeline"></a>
</h2>
<p>Individual guardrails and compositions are useful for targeted
checks, but a production agent needs all three defense layers working
together. A pipeline bundles guardrails for input, code, and output into
a single object with dedicated methods for each stage. This ensures
consistent configuration – you define your security policy once and
apply it uniformly across every agent turn.</p>
<div class="section level3">
<h3 id="defining-a-pipeline">Defining a Pipeline<a class="anchor" aria-label="anchor" href="#defining-a-pipeline"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secure_pipeline.html">secure_pipeline</a></span><span class="op">(</span></span>
<span>  input_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_prompt_injection.html">guard_prompt_injection</a></span><span class="op">(</span>sensitivity <span class="op">=</span> <span class="st">"high"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_input_pii.html">guard_input_pii</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_topic_scope.html">guard_topic_scope</a></span><span class="op">(</span>allowed_topics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"statistics"</span>, <span class="st">"data analysis"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  code_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">15</span>, max_calls <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_code_dependencies.html">guard_code_dependencies</a></span><span class="op">(</span>allowed_packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"tidyr"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span>block_network <span class="op">=</span> <span class="cn">TRUE</span>, block_file_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  output_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_output_pii.html">guard_output_pii</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_output_secrets.html">guard_output_secrets</a></span><span class="op">(</span>action <span class="op">=</span> <span class="st">"redact"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_output_size.html">guard_output_size</a></span><span class="op">(</span>max_chars <span class="op">=</span> <span class="fl">10000</span>, max_lines <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-each-stage">Running Each Stage<a class="anchor" aria-label="anchor" href="#running-each-stage"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Stage 1: validate user input</span></span>
<span><span class="va">input_result</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_input</span><span class="op">(</span><span class="st">"Calculate the mean and sd of mtcars$mpg"</span><span class="op">)</span></span>
<span><span class="va">input_result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Stage 2: validate LLM-generated code</span></span>
<span><span class="va">code_result</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_code</span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  library(dplyr)</span></span>
<span><span class="st">  mtcars %&gt;%</span></span>
<span><span class="st">    summarise(mean_mpg = mean(mpg), sd_mpg = sd(mpg))</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">code_result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Stage 3: filter execution output</span></span>
<span><span class="va">output_result</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_output</span><span class="op">(</span><span class="st">"mean_mpg = 20.09, sd_mpg = 6.03"</span><span class="op">)</span></span>
<span><span class="va">output_result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">output_result</span><span class="op">$</span><span class="va">result</span>  <span class="co"># possibly redacted text</span></span>
<span><span class="co">#&gt; [1] "mean_mpg = 20.09, sd_mpg = 6.03"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pipeline-in-an-agent-loop">Pipeline in an Agent Loop<a class="anchor" aria-label="anchor" href="#pipeline-in-an-agent-loop"></a>
</h3>
<p>The three <code>check_*</code> methods are designed to be called
sequentially in an agent loop. Each stage short-circuits on failure: if
<code>check_input()</code> rejects the prompt, you skip the LLM call
entirely, saving both time and cost. If <code>check_code()</code>
rejects the generated code, you skip execution, preventing any side
effects. Here is the complete pattern:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">process_turn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pipeline</span>, <span class="va">user_prompt</span>, <span class="va">llm_fn</span>, <span class="va">execute_fn</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. Input guardrails</span></span>
<span></span>
<span>  <span class="va">input_check</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_input</span><span class="op">(</span><span class="va">user_prompt</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">input_check</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      success <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      stage <span class="op">=</span> <span class="st">"input"</span>,</span>
<span>      reasons <span class="op">=</span> <span class="va">input_check</span><span class="op">$</span><span class="va">reasons</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 2. LLM generates code</span></span>
<span>  <span class="va">code</span> <span class="op">&lt;-</span> <span class="fu">llm_fn</span><span class="op">(</span><span class="va">user_prompt</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 3. Code guardrails</span></span>
<span>  <span class="va">code_check</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_code</span><span class="op">(</span><span class="va">code</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">code_check</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      success <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      stage <span class="op">=</span> <span class="st">"code"</span>,</span>
<span>      reasons <span class="op">=</span> <span class="va">code_check</span><span class="op">$</span><span class="va">reasons</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 4. Execute in sandbox</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">execute_fn</span><span class="op">(</span><span class="va">code</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 5. Output guardrails</span></span>
<span>  <span class="va">output_check</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_output</span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">output_check</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      success <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      stage <span class="op">=</span> <span class="st">"output"</span>,</span>
<span>      reasons <span class="op">=</span> <span class="va">output_check</span><span class="op">$</span><span class="va">reasons</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>success <span class="op">=</span> <span class="cn">TRUE</span>, result <span class="op">=</span> <span class="va">output_check</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mixing-custom-and-built-in-guardrails">Mixing Custom and Built-In Guardrails<a class="anchor" aria-label="anchor" href="#mixing-custom-and-built-in-guardrails"></a>
</h2>
<p>One of the key design principles in secureguard is that custom and
built-in guardrails share the same interface. This means custom
guardrails compose seamlessly with built-in ones – you can mix them
freely in <code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code>, <code><a href="../reference/check_all.html">check_all()</a></code>,
and <code><a href="../reference/secure_pipeline.html">secure_pipeline()</a></code>. There is no special registration
step or plugin system; if it is a <code>secureguard</code> object, it
works everywhere:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The SQL injection guard from earlier alongside built-in input guards</span></span>
<span><span class="va">input_guards</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_prompt_injection.html">guard_prompt_injection</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_input_pii.html">guard_input_pii</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">guard_sql_injection</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">input_guards</span>, <span class="st">"Please help me write a SELECT query"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">input_guards</span>, <span class="st">"' OR 1=1 --"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Potential SQL injection detected</span></span></code></pre></div>
<p>Similarly for code guardrails:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Custom length guard composed with built-in code guards</span></span>
<span><span class="va">code_guards</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  <span class="fu">guard_code_length</span><span class="op">(</span>max_lines <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">code_guards</span>, <span class="st">"x &lt;- mean(1:10)"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="integration-with-securer">Integration with securer<a class="anchor" aria-label="anchor" href="#integration-with-securer"></a>
</h2>
<p>secureguard provides semantic analysis of code and outputs – it
understands what the code does. <a href="https://github.com/ian-flores/securer" class="external-link">securer</a> provides
OS-level sandboxing – it limits what the code <strong>can</strong> do,
regardless of what it tries. Together they form two independent defense
layers: secureguard catches known-dangerous patterns before execution,
and securer contains unknown threats at the operating system level.</p>
<p>securer is a suggested dependency – all of the patterns above work
without it. The integration layer adds two capabilities: pre-execution
hooks and output guarding after execution.</p>
<div class="section level3">
<h3 id="pre-execute-hooks">Pre-Execute Hooks<a class="anchor" aria-label="anchor" href="#pre-execute-hooks"></a>
</h3>
<p><code><a href="../reference/as_pre_execute_hook.html">as_pre_execute_hook()</a></code> converts code guardrails into a
function that securer calls before executing each code snippet. It
returns <code>TRUE</code> to allow execution or <code>FALSE</code> to
block it.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/securer/" class="external-link">securer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/secureguard/">secureguard</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">hook</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_pre_execute_hook.html">as_pre_execute_hook</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sess</span> <span class="op">&lt;-</span> <span class="va"><a href="https://ian-flores.github.io/securer/reference/SecureSession.html" class="external-link">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pre_execute_hook <span class="op">=</span> <span class="va">hook</span><span class="op">)</span></span>
<span><span class="va">sess</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"mean(1:10)"</span><span class="op">)</span>        <span class="co"># allowed</span></span>
<span><span class="va">sess</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"system('whoami')"</span><span class="op">)</span>  <span class="co"># blocked by code_analysis</span></span>
<span><span class="va">sess</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"Sys.getenv('KEY')"</span><span class="op">)</span> <span class="co"># blocked by dataflow</span></span>
<span><span class="va">sess</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="post-execute-output-guarding">Post-Execute Output Guarding<a class="anchor" aria-label="anchor" href="#post-execute-output-guarding"></a>
</h3>
<p><code><a href="../reference/guard_output.html">guard_output()</a></code> runs output guardrails on execution
results. Guardrails with <code>action = "redact"</code> transform the
output rather than blocking it:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">sess</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"paste('My API key is', 'AKIAIOSFODNN7EXAMPLE')"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">checked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/guard_output.html">guard_output</a></span><span class="op">(</span></span>
<span>  <span class="va">result</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_output_pii.html">guard_output_pii</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_output_secrets.html">guard_output_secrets</a></span><span class="op">(</span>action <span class="op">=</span> <span class="st">"redact"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">checked</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Return the (possibly redacted) result to the user</span></span>
<span>  <span class="va">checked</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Blocked:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">checked</span><span class="op">$</span><span class="va">reasons</span>, collapse <span class="op">=</span> <span class="st">"; "</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pipeline-hook">Pipeline Hook<a class="anchor" aria-label="anchor" href="#pipeline-hook"></a>
</h3>
<p>A pipeline can produce a pre-execute hook from its code
guardrails:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secure_pipeline.html">secure_pipeline</a></span><span class="op">(</span></span>
<span>  input_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/guard_prompt_injection.html">guard_prompt_injection</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  code_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  output_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_output_secrets.html">guard_output_secrets</a></span><span class="op">(</span>action <span class="op">=</span> <span class="st">"redact"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sess</span> <span class="op">&lt;-</span> <span class="va"><a href="https://ian-flores.github.io/securer/reference/SecureSession.html" class="external-link">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  pre_execute_hook <span class="op">=</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">as_pre_execute_hook</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The session now has code guardrails enforced automatically.</span></span>
<span><span class="co"># Input and output guardrails are checked manually:</span></span>
<span><span class="va">input_check</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_input</span><span class="op">(</span><span class="va">user_prompt</span><span class="op">)</span></span>
<span><span class="co"># ... LLM generates code, session executes it ...</span></span>
<span><span class="va">output_check</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_output</span><span class="op">(</span><span class="va">execution_result</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sess</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="advanced-composition-patterns">Advanced Composition Patterns<a class="anchor" aria-label="anchor" href="#advanced-composition-patterns"></a>
</h2>
<p>The patterns above cover the common case: apply the same guardrails
uniformly to every request. In practice, you often need to vary
guardrail strictness based on context – who the user is, where the
request came from, and what level of trust is appropriate. The following
patterns show how to build adaptive guardrail configurations.</p>
<div class="section level3">
<h3 id="layered-sensitivity">Layered Sensitivity<a class="anchor" aria-label="anchor" href="#layered-sensitivity"></a>
</h3>
<p>Not all contexts require the same level of strictness. A
public-facing chatbot is exposed to adversarial users and needs
high-sensitivity injection detection and tight topic scoping. An
internal analytics tool used by trusted data scientists can afford lower
sensitivity to avoid false positives on legitimate analytical
prompts:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Public-facing: high sensitivity, strict topic scoping</span></span>
<span><span class="va">public_guards</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_prompt_injection.html">guard_prompt_injection</a></span><span class="op">(</span>sensitivity <span class="op">=</span> <span class="st">"high"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_input_pii.html">guard_input_pii</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_topic_scope.html">guard_topic_scope</a></span><span class="op">(</span>allowed_topics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data analysis"</span>, <span class="st">"statistics"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Internal tool: lower sensitivity, broader topics</span></span>
<span><span class="va">internal_guards</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_prompt_injection.html">guard_prompt_injection</a></span><span class="op">(</span>sensitivity <span class="op">=</span> <span class="st">"low"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_input_pii.html">guard_input_pii</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span></span>
<span>  <span class="va">public_guards</span>,</span>
<span>  <span class="st">"Continue from where we left off with the regression"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Prompt injection detected: continuation_attack; Input does not match</span></span>
<span><span class="co">#&gt; any allowed topic.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span></span>
<span>  <span class="va">internal_guards</span>,</span>
<span>  <span class="st">"Continue from where we left off with the regression"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graduated-code-restrictions">Graduated Code Restrictions<a class="anchor" aria-label="anchor" href="#graduated-code-restrictions"></a>
</h3>
<p>The same principle applies to code guardrails. A trusted internal
user running vetted analysis scripts needs fewer restrictions than an
untrusted external user whose prompts generate arbitrary code. By
defining multiple guardrail configurations and selecting one based on
context, you can balance security with usability:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trusted context: only block the most dangerous operations</span></span>
<span><span class="va">trusted_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span>blocked_functions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"system"</span>, <span class="st">"system2"</span>, <span class="st">"shell"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span></span>
<span>    block_env_access <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    block_network <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    block_file_write <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Untrusted context: strict lockdown</span></span>
<span><span class="va">untrusted_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compose_guardrails.html">compose_guardrails</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/guard_code_analysis.html">guard_code_analysis</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_complexity.html">guard_code_complexity</a></span><span class="op">(</span>max_ast_depth <span class="op">=</span> <span class="fl">10</span>, max_calls <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dependencies.html">guard_code_dependencies</a></span><span class="op">(</span>allowed_packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/guard_code_dataflow.html">guard_code_dataflow</a></span><span class="op">(</span></span>
<span>    block_env_access <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    block_network <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    block_file_write <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    block_file_read <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The same code may pass in trusted but fail in untrusted</span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">"readLines('data.csv')"</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">trusted_code</span>, <span class="va">code</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; PASS</span></span>
<span><span class="fu"><a href="../reference/run_guardrail.html">run_guardrail</a></span><span class="op">(</span><span class="va">untrusted_code</span>, <span class="va">code</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;guardrail_result&gt; FAIL</span></span>
<span><span class="co">#&gt; Reason: Data flow violation(s): readLines</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="redact-vs-block-decision">Redact vs Block Decision<a class="anchor" aria-label="anchor" href="#redact-vs-block-decision"></a>
</h3>
<p>Not all sensitive data in output requires the same response. PII like
social security numbers or patient records should block the entire
response – partial disclosure is still a privacy violation. But API keys
and tokens can often be redacted in place, preserving the useful parts
of the response while removing the sensitive value. Output guardrails
support three actions (<code>"block"</code>, <code>"redact"</code>,
<code>"warn"</code>) that let you make this distinction explicitly:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PII blocks the output entirely</span></span>
<span><span class="co"># Secrets get redacted so the response is still useful</span></span>
<span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secure_pipeline.html">secure_pipeline</a></span><span class="op">(</span></span>
<span>  output_guardrails <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/guard_output_pii.html">guard_output_pii</a></span><span class="op">(</span><span class="op">)</span>,                         <span class="co"># blocks on PII</span></span>
<span>    <span class="fu"><a href="../reference/guard_output_secrets.html">guard_output_secrets</a></span><span class="op">(</span>action <span class="op">=</span> <span class="st">"redact"</span><span class="op">)</span>,     <span class="co"># redacts secrets</span></span>
<span>    <span class="fu"><a href="../reference/guard_output_size.html">guard_output_size</a></span><span class="op">(</span>max_chars <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span>          <span class="co"># blocks oversized output</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Secrets are redacted, not blocked</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_output</span><span class="op">(</span><span class="st">"API key: AKIAIOSFODNN7EXAMPLE, data looks good"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="co">#&gt; [1] "API key: [REDACTED_AWS_KEY], data looks good"</span></span>
<span></span>
<span><span class="co"># PII causes a block</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">pipeline</span><span class="op">$</span><span class="fu">check_output</span><span class="op">(</span><span class="st">"Patient SSN: 123-45-6789"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">pass</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">reasons</span></span>
<span><span class="co">#&gt; [1] "PII detected in output: ssn"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<colgroup>
<col width="31%">
<col width="34%">
<col width="34%">
</colgroup>
<thead><tr class="header">
<th>Pattern</th>
<th>Function</th>
<th>Use Case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Custom guardrail</td>
<td><code><a href="../reference/new_guardrail.html">new_guardrail()</a></code></td>
<td>Domain-specific checks</td>
</tr>
<tr class="even">
<td>Same-type composition</td>
<td><code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code></td>
<td>Merge guards into one reusable unit</td>
</tr>
<tr class="odd">
<td>Batch check</td>
<td><code><a href="../reference/check_all.html">check_all()</a></code></td>
<td>Individual results per guard (diagnostics)</td>
</tr>
<tr class="even">
<td>Full pipeline</td>
<td><code><a href="../reference/secure_pipeline.html">secure_pipeline()</a></code></td>
<td>Three-layer defense for production</td>
</tr>
<tr class="odd">
<td>Pre-execute hook</td>
<td><code><a href="../reference/as_pre_execute_hook.html">as_pre_execute_hook()</a></code></td>
<td>securer integration</td>
</tr>
<tr class="even">
<td>Output guard</td>
<td><code><a href="../reference/guard_output.html">guard_output()</a></code></td>
<td>Post-execution filtering</td>
</tr>
</tbody>
</table>
<p>The key design principle is that guardrails are composable values.
Build small, focused guards that each address one threat. Compose them
for your context using <code><a href="../reference/compose_guardrails.html">compose_guardrails()</a></code> or
<code><a href="../reference/check_all.html">check_all()</a></code>. Assemble them into pipelines that protect
every stage of an agent workflow. And when the built-in guardrails do
not cover your domain, extend the system with
<code><a href="../reference/new_guardrail.html">new_guardrail()</a></code> – custom guards compose identically to
built-in ones.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
